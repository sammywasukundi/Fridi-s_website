<?php
// insertion messages 
if(isset($_POST['submit_message'])){
    if(isset($_POST['destinataire_mail'],$_POST['message'],$_POST['monTextarea'])){
        if (!empty($_POST['destinataire_mail'] && !empty($_POST['message']) && !empty($_POST['monTextarea']))){
            $destinataire_mail=htmlspecialchars($_POST['destinataire_mail']);
            $message=htmlspecialchars($_POST['message']);
            $monTextarea=htmlspecialchars($_POST['monTextarea']);

            if(preg_match("#^[a-z0-9._-]+@[a-z0-9._-]{2,}\.[a-z]{2,4}$#",htmlspecialchars($_POST['destinataire_mail']))){
                if(isset($_FILES['monInputFile']) AND $_FILES['monInputFile']['error'] == 0){
                    if($_FILES['monInputFile']['size'] < 8000000)
                    {
                        $nom_fichier = pathinfo($_FILES['monInputFile']['name']);
                        $recup_extension =  $nom_fichier['extension'];
                        $extensions =array('zip','rar','iso','pdf','docx','xlx');
                        if(in_array($recup_extension,$extensions)){
                            if(move_uploaded_file($_FILES['monInputFile']['tmp_name'],'fichier_email/'.basename($_FILES['monInputFile']['name'])))
                            {
                                $req = $pdo->prepare("INSERT INTO table_message(destinataire_mail,message,monTextarea,monInputFile) VALUES(:destinataire_mail,:message,:monTextarea,:monInputFile)");
                                $req->execute(array(
                                    'destinataire_mail' => $destinataire_mail,
                                    'message' => $message,
                                    'monTextarea' => $monTextarea,
                                    'monInputFile' => $_FILES['monInputFile']['name']
                                ));                            
                                if($req == true){
                                    echo "<script>
                                    alert('message envoyé avec succès');            
                                    </script>";
                                    exit(0);
                                }
                                else{
                                    echo "<script>
                                    alert('message non envoyé');                    
                                    </script>";
                                    exit(0);
                                }                   
                            }
                        }else{
                            echo "<script>
                            alert('extension non autorisée');            
                            </script>";
                        }
                    }else
                    {
                        echo "<script>
                        alert('Fichier volumineux'); 
                        </script>";

                    }
                }
            }else{
                echo "<script>
                alert('Veuillez entrer une adresse email valide'); 
                </script>";
            }   
        }
        else{
            echo "<script>
            alert('Veuillez compéter toutes les cases'); 
            </script>";
        }
    }
}
?>